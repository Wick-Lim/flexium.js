<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flexium DOM Rendering Benchmarks</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .benchmark-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .benchmark-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .benchmark-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: #667eea;
    }

    .run-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .run-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .run-btn:active {
      transform: translateY(0);
    }

    .run-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .results {
      display: none;
      margin-top: 16px;
    }

    .results.visible {
      display: block;
    }

    .result-item {
      display: flex;
      justify-content: space-between;
      padding: 12px;
      margin: 8px 0;
      background: #f7fafc;
      border-radius: 6px;
      border-left: 4px solid #667eea;
    }

    .result-label {
      font-weight: 500;
      color: #4a5568;
    }

    .result-value {
      font-weight: 600;
      color: #667eea;
      font-family: 'Monaco', 'Courier New', monospace;
    }

    .result-value.fast {
      color: #48bb78;
    }

    .result-value.medium {
      color: #ed8936;
    }

    .result-value.slow {
      color: #f56565;
    }

    #test-container {
      min-height: 100px;
      border: 2px dashed #cbd5e0;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
      background: #f7fafc;
    }

    .progress {
      display: none;
      margin-top: 12px;
    }

    .progress.visible {
      display: block;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
    }

    .comparison-chart {
      display: grid;
      gap: 12px;
      margin-top: 16px;
    }

    .chart-bar {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .chart-label {
      width: 150px;
      font-weight: 500;
      color: #4a5568;
    }

    .chart-visual {
      flex: 1;
      height: 30px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 4px;
      position: relative;
      display: flex;
      align-items: center;
      padding: 0 12px;
      color: white;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .summary {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      text-align: center;
    }

    .summary h3 {
      margin-bottom: 12px;
      font-size: 1.5rem;
    }

    .summary-stat {
      display: inline-block;
      margin: 8px 16px;
      font-size: 1.1rem;
    }

    .memory-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .memory-card {
      background: #f7fafc;
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #764ba2;
    }

    .memory-label {
      font-size: 0.875rem;
      color: #718096;
      margin-bottom: 4px;
    }

    .memory-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #764ba2;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>âš¡ Flexium DOM Rendering Benchmarks</h1>

    <!-- Benchmark 1: Initial Render -->
    <div class="benchmark-card">
      <div class="benchmark-header">
        <div class="benchmark-title">1. Initial Render Performance</div>
        <button class="run-btn" onclick="runInitialRenderBenchmark()">Run Test</button>
      </div>
      <div class="progress" id="progress-1">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill-1"></div>
        </div>
      </div>
      <div id="test-container"></div>
      <div class="results" id="results-1"></div>
    </div>

    <!-- Benchmark 2: Update Performance -->
    <div class="benchmark-card">
      <div class="benchmark-header">
        <div class="benchmark-title">2. Update Performance (1, 100, 1000 elements)</div>
        <button class="run-btn" onclick="runUpdateBenchmark()">Run Test</button>
      </div>
      <div class="progress" id="progress-2">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill-2"></div>
        </div>
      </div>
      <div class="results" id="results-2"></div>
    </div>

    <!-- Benchmark 3: Fine-grained vs Full Re-render -->
    <div class="benchmark-card">
      <div class="benchmark-header">
        <div class="benchmark-title">3. Fine-grained Updates vs Full Re-render</div>
        <button class="run-btn" onclick="runGranularityBenchmark()">Run Test</button>
      </div>
      <div class="progress" id="progress-3">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill-3"></div>
        </div>
      </div>
      <div class="results" id="results-3"></div>
    </div>

    <!-- Benchmark 4: Memory Usage -->
    <div class="benchmark-card">
      <div class="benchmark-header">
        <div class="benchmark-title">4. Memory Usage Analysis</div>
        <button class="run-btn" onclick="runMemoryBenchmark()">Run Test</button>
      </div>
      <div class="results" id="results-4"></div>
    </div>

    <!-- Summary -->
    <div class="summary" id="summary" style="display: none;">
      <h3>ðŸŽ‰ Overall Performance</h3>
      <div id="summary-content"></div>
    </div>
  </div>

  <script type="module">
    import { signal, computed, effect, batch } from '../dist/index.mjs';
    import { h, render } from '../dist/dom.mjs';

    window.signal = signal;
    window.computed = computed;
    window.effect = effect;
    window.batch = batch;
    window.h = h;
    window.render = render;

    // Utility functions
    function formatTime(ms) {
      if (ms < 1) return `${(ms * 1000).toFixed(2)}Âµs`;
      return `${ms.toFixed(2)}ms`;
    }

    function formatMemory(bytes) {
      if (bytes < 1024) return `${bytes}B`;
      if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(2)}KB`;
      return `${(bytes / 1024 / 1024).toFixed(2)}MB`;
    }

    function showProgress(id, percent) {
      const progress = document.getElementById(`progress-${id}`);
      const fill = document.getElementById(`progress-fill-${id}`);
      progress.classList.add('visible');
      fill.style.width = `${percent}%`;
    }

    function hideProgress(id) {
      const progress = document.getElementById(`progress-${id}`);
      progress.classList.remove('visible');
    }

    function showResults(id, html) {
      const results = document.getElementById(`results-${id}`);
      results.innerHTML = html;
      results.classList.add('visible');
    }

    function getPerformanceClass(ms, thresholds = [10, 50, 100]) {
      if (ms < thresholds[0]) return 'fast';
      if (ms < thresholds[1]) return 'medium';
      return 'slow';
    }

    // Benchmark 1: Initial Render
    window.runInitialRenderBenchmark = async function() {
      const container = document.getElementById('test-container');
      const sizes = [10, 100, 1000];
      const results = [];

      for (let i = 0; i < sizes.length; i++) {
        showProgress(1, ((i + 1) / sizes.length) * 100);

        const size = sizes[i];
        container.innerHTML = '';

        await new Promise(resolve => setTimeout(resolve, 100));

        const start = performance.now();

        const items = Array.from({ length: size }, (_, i) =>
          h('div', { style: 'padding: 8px; border-bottom: 1px solid #e2e8f0;' },
            `Item ${i + 1}`
          )
        );

        render(h('div', {}, ...items), container);

        const end = performance.now();
        const time = end - start;

        results.push({ size, time });

        await new Promise(resolve => setTimeout(resolve, 100));
      }

      hideProgress(1);

      const html = `
        ${results.map(r => `
          <div class="result-item">
            <span class="result-label">${r.size} elements</span>
            <span class="result-value ${getPerformanceClass(r.time)}">${formatTime(r.time)}</span>
          </div>
        `).join('')}
        <div class="comparison-chart">
          ${results.map(r => `
            <div class="chart-bar">
              <div class="chart-label">${r.size} elements</div>
              <div class="chart-visual" style="width: ${(r.time / Math.max(...results.map(x => x.time)) * 100)}%">
                ${formatTime(r.time)}
              </div>
            </div>
          `).join('')}
        </div>
      `;

      showResults(1, html);
    };

    // Benchmark 2: Update Performance
    window.runUpdateBenchmark = async function() {
      const container = document.getElementById('test-container');
      const sizes = [1, 100, 1000];
      const results = [];

      for (let i = 0; i < sizes.length; i++) {
        showProgress(2, ((i + 1) / sizes.length) * 100);

        const size = sizes[i];
        container.innerHTML = '';

        // Create signals
        const counters = Array.from({ length: size }, () => signal(0));

        // Render initial state
        const items = counters.map((counter, i) => {
          const div = h('div', {
            style: 'padding: 8px; border-bottom: 1px solid #e2e8f0;'
          }, `Item ${i}: ${counter.value}`);

          // Set up reactive update
          effect(() => {
            if (div instanceof HTMLElement) {
              div.textContent = `Item ${i}: ${counter.value}`;
            }
          });

          return div;
        });

        render(h('div', {}, ...items), container);

        await new Promise(resolve => setTimeout(resolve, 100));

        // Measure update time
        const updateCount = 100;
        const start = performance.now();

        for (let j = 0; j < updateCount; j++) {
          counters[Math.floor(Math.random() * counters.length)].value++;
        }

        const end = performance.now();
        const time = end - start;
        const avgTime = time / updateCount;

        results.push({ size, time, avgTime });

        await new Promise(resolve => setTimeout(resolve, 100));
      }

      hideProgress(2);

      const html = `
        ${results.map(r => `
          <div class="result-item">
            <span class="result-label">${r.size} elements (100 updates)</span>
            <span class="result-value ${getPerformanceClass(r.avgTime, [0.1, 1, 5])}">${formatTime(r.avgTime)}/update</span>
          </div>
        `).join('')}
        <div class="comparison-chart">
          ${results.map(r => `
            <div class="chart-bar">
              <div class="chart-label">${r.size} elements</div>
              <div class="chart-visual" style="width: ${(r.avgTime / Math.max(...results.map(x => x.avgTime)) * 100)}%">
                ${formatTime(r.avgTime)}/update
              </div>
            </div>
          `).join('')}
        </div>
      `;

      showResults(2, html);
    };

    // Benchmark 3: Fine-grained vs Full Re-render
    window.runGranularityBenchmark = async function() {
      const container = document.getElementById('test-container');
      const elementCount = 100;
      const updateCount = 100;

      showProgress(3, 33);

      // Test 1: Fine-grained updates (Flexium way)
      container.innerHTML = '';
      const signals = Array.from({ length: elementCount }, () => signal(0));

      const items = signals.map((sig, i) => {
        const div = h('div', {
          style: 'padding: 8px; border-bottom: 1px solid #e2e8f0;'
        }, `Item ${i}: ${sig.value}`);

        effect(() => {
          if (div instanceof HTMLElement) {
            div.textContent = `Item ${i}: ${sig.value}`;
          }
        });

        return div;
      });

      render(h('div', {}, ...items), container);

      await new Promise(resolve => setTimeout(resolve, 100));
      showProgress(3, 66);

      const fineStart = performance.now();
      for (let i = 0; i < updateCount; i++) {
        signals[50].value++;
      }
      const fineEnd = performance.now();
      const fineTime = fineEnd - fineStart;

      await new Promise(resolve => setTimeout(resolve, 100));

      // Test 2: Full re-render
      container.innerHTML = '';
      let state = Array.from({ length: elementCount }, () => 0);

      function fullRender() {
        container.innerHTML = '';
        const items = state.map((value, i) =>
          h('div', {
            style: 'padding: 8px; border-bottom: 1px solid #e2e8f0;'
          }, `Item ${i}: ${value}`)
        );
        render(h('div', {}, ...items), container);
      }

      fullRender();

      await new Promise(resolve => setTimeout(resolve, 100));

      const fullStart = performance.now();
      for (let i = 0; i < updateCount; i++) {
        state[50]++;
        fullRender();
      }
      const fullEnd = performance.now();
      const fullTime = fullEnd - fullStart;

      hideProgress(3);

      const speedup = (fullTime / fineTime).toFixed(2);

      const html = `
        <div class="result-item">
          <span class="result-label">Fine-grained (${updateCount} updates)</span>
          <span class="result-value fast">${formatTime(fineTime)}</span>
        </div>
        <div class="result-item">
          <span class="result-label">Full re-render (${updateCount} updates)</span>
          <span class="result-value slow">${formatTime(fullTime)}</span>
        </div>
        <div class="result-item" style="border-left-color: #48bb78; background: #f0fff4;">
          <span class="result-label">Speedup</span>
          <span class="result-value fast">${speedup}x faster</span>
        </div>
        <div class="comparison-chart">
          <div class="chart-bar">
            <div class="chart-label">Fine-grained</div>
            <div class="chart-visual" style="width: ${(fineTime / fullTime * 100)}%; background: linear-gradient(90deg, #48bb78 0%, #38a169 100%);">
              ${formatTime(fineTime)}
            </div>
          </div>
          <div class="chart-bar">
            <div class="chart-label">Full re-render</div>
            <div class="chart-visual" style="width: 100%; background: linear-gradient(90deg, #f56565 0%, #e53e3e 100%);">
              ${formatTime(fullTime)}
            </div>
          </div>
        </div>
      `;

      showResults(3, html);
    };

    // Benchmark 4: Memory Usage
    window.runMemoryBenchmark = async function() {
      if (!performance.memory) {
        showResults(4, `
          <div class="result-item">
            <span class="result-label">Memory API not available</span>
            <span class="result-value">Use Chrome with --enable-precise-memory-info</span>
          </div>
        `);
        return;
      }

      const getMemory = () => ({
        used: performance.memory.usedJSHeapSize,
        total: performance.memory.totalJSHeapSize,
        limit: performance.memory.jsHeapSizeLimit
      });

      // Baseline
      if (window.gc) window.gc();
      await new Promise(resolve => setTimeout(resolve, 100));
      const baseline = getMemory();

      // Create 1000 signals
      const signals = Array.from({ length: 1000 }, (_, i) => signal(i));
      const after1000 = getMemory();

      // Create 1000 computed signals
      const computed1000 = signals.map(s => computed(() => s.value * 2));
      const after2000 = getMemory();

      // Create effects
      const disposes = signals.map((s, i) => effect(() => {
        const v = s.value;
      }));
      const after3000 = getMemory();

      // Cleanup
      disposes.forEach(d => d());

      const memPerSignal = (after1000.used - baseline.used) / 1000;
      const memPerComputed = (after2000.used - after1000.used) / 1000;
      const memPerEffect = (after3000.used - after2000.used) / 1000;

      const html = `
        <div class="memory-info">
          <div class="memory-card">
            <div class="memory-label">Baseline Memory</div>
            <div class="memory-value">${formatMemory(baseline.used)}</div>
          </div>
          <div class="memory-card">
            <div class="memory-label">Memory per Signal</div>
            <div class="memory-value">${formatMemory(memPerSignal)}</div>
          </div>
          <div class="memory-card">
            <div class="memory-label">Memory per Computed</div>
            <div class="memory-value">${formatMemory(memPerComputed)}</div>
          </div>
          <div class="memory-card">
            <div class="memory-label">Memory per Effect</div>
            <div class="memory-value">${formatMemory(memPerEffect)}</div>
          </div>
          <div class="memory-card">
            <div class="memory-label">Total (1000 each)</div>
            <div class="memory-value">${formatMemory(after3000.used - baseline.used)}</div>
          </div>
          <div class="memory-card">
            <div class="memory-label">Heap Limit</div>
            <div class="memory-value">${formatMemory(baseline.limit)}</div>
          </div>
        </div>
      `;

      showResults(4, html);
    };

    console.log('Flexium DOM Benchmarks loaded. Click buttons to run tests.');
  </script>
</body>
</html>
